const { Executor } = require("selenium-webdriver/lib/command.js");
const { initBrowserDriver, db } = require("./initter.js");
const { Builder, By, until, Key } = require("selenium-webdriver");

// DBへの試しのデータ挿入更新
async function dbPointUpsert() {
  let date = new Date();
  let idStr =
    date.getFullYear().toString().substring(2) +
    (date.getMonth() + 1).toString().padStart(2, "0") +
    date.getDate().toString().padStart(2, "0");
  let doc = {
    _id: idStr,
    pex: { p: 0, date: date, exch: null, diff: 0 },
    mod_date: date,
    diff: 0,
    total: 0,
  };
  console.log("1");
  // coll, method, cond = {}, doc
  await db("point", "update", { _id: idStr }, doc);
  console.log("2");
}
async function eleFromEleWait() {
  let driver = await initBrowserDriver();
  await driver.get("https://ecnavi.jp/");
  let eles = await driver.findElements(By.css("nav>ul>li"));
  for (let i = 0; i < eles.length; i++) {
    console.log(i);
    let ele = null;
    try {
      ele = await eles[i].findElements(By.css("a"));
    } catch (e) {
      console.log("no such!");
    }
    // if (ele && ele.length) {
    //   // console.log(ele);
    //   let tex = await ele[0].getText();
    //   console.log("ari[" + tex);
    // }
  }
  driver.quit();
  console.log("owari");
}
async function scrollClick() {
  let driver = await initBrowserDriver();
  await driver.get(
    "https://www.google.com/search?q=%E3%83%90%E3%83%B3%E3%83%90%E3%83%B3%E3%83%90%E3%82%B6%E3%83%BC%E3%83%AB&newwindow=1&biw=758&bih=668&sxsrf=ALiCzsblDKfdFPRlQ1UgOWnCFtv8K_mZsg%3A1668049312985&ei=oGlsY5TmO7m52roPupiRoAo&ved=0ahUKEwiUtpL2z6L7AhW5nFYBHTpMBKQQ4dUDCA8&uact=5&oq=%E3%83%90%E3%83%B3%E3%83%90%E3%83%B3%E3%83%90%E3%82%B6%E3%83%BC%E3%83%AB&gs_lcp=Cgxnd3Mtd2l6LXNlcnAQAzIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDoHCCMQsAMQJzoHCCMQ6gIQJzoECCMQJzoECAAQQzoNCAAQBBCABBCxAxCDAToGCAAQBBADOgoIABAEEIAEELEDOhAIABAEEIAEELEDEIMBEMkDOgUIABCSAzoNCAAQBBCABBCxAxCxAzoJCAAQBBCABBAKSgQIQRgBSgQIRhgAUKghWNJmYPNoaAZwAHgAgAF3iAGkD5IBBDE0LjaYAQCgAQGwAQrIAQPAAQE&sclient=gws-wiz-serp"
  );
  let eles = await driver.findElements(By.css("h3"));
  await driver.actions().scroll(0, 0, 0, 0, eles[8]).perform();
  await driver.sleep(2000);
  console.log(await eles[11].getText());
  await eles[11].click();
  await driver.sleep(5000);
  driver.quit();
  console.log("owari");
}
async function porling() {
  let count = 0;
  const countUp = () => {
    console.log(count++);
  };
  await setInterval(countUp, 10000);
}
async function getPexPoint() {
  let driver = await initBrowserDriver();
  await driver.get("https://pex.jp/");
  let tergetUrl = "https://pex.jp/user/point_passbook/all";
  await driver.get(tergetUrl);
  await driver.sleep(3000);
  // ホントは存在確認してから
  let ele = await driver.findElement(By.css("dl.point_area>dd>span"));
  let nakedNum = await ele.getText();
  console.log("now point total:" + nakedNum);
  console.log("こっちは終わり");
  driver.quit();
}
async function getZoom() {
  let driver = await initBrowserDriver();
  await driver.get(
    "https://www.google.com/search?q=%E3%83%90%E3%83%B3%E3%83%90%E3%83%B3%E3%83%90%E3%82%B6%E3%83%BC%E3%83%AB&newwindow=1&biw=758&bih=668&sxsrf=ALiCzsblDKfdFPRlQ1UgOWnCFtv8K_mZsg%3A1668049312985&ei=oGlsY5TmO7m52roPupiRoAo&ved=0ahUKEwiUtpL2z6L7AhW5nFYBHTpMBKQQ4dUDCA8&uact=5&oq=%E3%83%90%E3%83%B3%E3%83%90%E3%83%B3%E3%83%90%E3%82%B6%E3%83%BC%E3%83%AB&gs_lcp=Cgxnd3Mtd2l6LXNlcnAQAzIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDIHCAAQBBCABDoHCCMQsAMQJzoHCCMQ6gIQJzoECCMQJzoECAAQQzoNCAAQBBCABBCxAxCDAToGCAAQBBADOgoIABAEEIAEELEDOhAIABAEEIAEELEDEIMBEMkDOgUIABCSAzoNCAAQBBCABBCxAxCxAzoJCAAQBBCABBAKSgQIQRgBSgQIRhgAUKghWNJmYPNoaAZwAHgAgAF3iAGkD5IBBDE0LjaYAQCgAQGwAQrIAQPAAQE&sclient=gws-wiz-serp"
  );
  let zooml = await driver.executeScript(
    "return window.devicePixelRatio || window.screen.availWidth / document.documentElement.clientWidth * 100;"
  );
  console.log(zooml);
  zooml = zooml * 100;
  console.log(zooml + "%");
  let action = await driver.actions();
  // 以下は失敗
  let eles = await driver.findElements(By.css("html"));
  await eles[0].sendKeys(Key.chord(Key.CONTROL, Key.SUBTRACT)).perform();
  await eles[0].sendKeys(Key.chord(Key.CONTROL, Key.SUBTRACT)).perform();
  await eles[0].sendKeys(Key.chord(Key.CONTROL, Key.SUBTRACT)).perform();
  await eles[0].sendKeys(Key.chord(Key.CONTROL, Key.SUBTRACT)).perform();
  // await action.sendKeys(Key.chord(Key.CONTROL, Key.SUBTRACT)).perform();
  zooml = await driver.executeScript(
    "return window.devicePixelRatio || window.screen.availWidth / document.documentElement.clientWidth * 100;"
  );
  console.log(zooml);
  zooml = zooml * 100;
  console.log(zooml + "%");

  // let eles = await driver.findElements(By.css("h3"));
  // await driver.actions().scroll(0, 0, 0, 0, eles[8]).perform();
  // await driver.sleep(2000);
  // console.log(await eles[11].getText());
  // await eles[11].click();
  await driver.sleep(5000);
  driver.quit();
  console.log("owari");
}
async function doKuroshio() {
  const { default: Kuroshiro } = require("kuroshiro");
  const KuroshiroAnalyzer = require("kuroshiro-analyzer-kuromoji");

  const kuroshiro = new Kuroshiro();
  await kuroshiro.init(new KuroshiroAnalyzer());
  const result = await kuroshiro.convert("膝下", { to: "hiragana" });
  console.log(result);
}
async function exe() {
  console.log(process.argv);
  switch (process.argv[2]) {
    case "dbPointInsert":
      await dbPointUpsert();
      break;
    case "eleFromEleWait":
      await eleFromEleWait();
      break;
    case "scrollClick":
      await scrollClick();
      break;
    case "porling":
      await porling();
      break;
    case "getPexPoint":
      await getPexPoint();
      break;
    case "getZoom":
      await getZoom();
      break;
    case "kuroshiro":
      await doKuroshio();
      break;
  }
  console.log("end--");
}
exe();
